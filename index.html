<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <link rel="icon" href="/src/assets/favicon.png" />
    <title>DaggerDice - Daggerheart RPG Dice Roller</title>
    <meta
      name="description"
      content="A 3D dice rolling web application designed for the Daggerheart RPG system, featuring Hope/Fear mechanics and real-time multiplayer sessions."
    />
    <meta
      name="keywords"
      content="daggerheart, rpg, dice, roller, hope, fear, multiplayer, tabletop, gaming, d12"
    />
    <meta name="author" content="DaggerDice" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <!-- Mobile browser theme colors and PWA settings -->
    <meta name="theme-color" content="#6e8efb" />
    <meta name="msapplication-navbutton-color" content="#6e8efb" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="DaggerDice" />
    <meta name="mobile-web-app-capable" content="yes" />

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

    <!-- Additional PWA icons -->
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/icons/icon-192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="/icons/icon-512.png"
    />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://daggerdice.smileychris.workers.dev/"
    />
    <meta
      property="og:title"
      content="DaggerDice - Daggerheart RPG Dice Roller"
    />
    <meta
      property="og:description"
      content="Roll Hope & Fear dice for Daggerheart RPG with realistic 3D physics and multiplayer sessions. Perfect for tabletop gaming."
    />
    <meta
      property="og:image"
      content="https://daggerdice.smileychris.workers.dev/icons/icon-512.png"
    />
    <meta property="og:image:width" content="512" />
    <meta property="og:image:height" content="512" />
    <meta property="og:site_name" content="DaggerDice" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta
      property="twitter:url"
      content="https://daggerdice.smileychris.workers.dev/"
    />
    <meta
      property="twitter:title"
      content="DaggerDice - Daggerheart RPG Dice Roller"
    />
    <meta
      property="twitter:description"
      content="Roll Hope & Fear dice for Daggerheart RPG with realistic 3D physics and multiplayer sessions."
    />
    <meta
      property="twitter:image"
      content="https://daggerdice.smileychris.workers.dev/icons/icon-512.png"
    />

    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#6e8efb" />
    <meta name="msapplication-TileImage" content="/icons/icon-192.png" />
    <meta name="msapplication-config" content="/browserconfig.xml" />
  </head>
  <body>
    <!-- Toast container -->
    <div class="toast-container" x-data="toastManager()" x-init="init()">
      <template x-for="toast in toasts" :key="toast.id">
        <div
          class="toast"
          :class="toast.type"
          x-show="toast.visible"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0 transform -translate-y-2 scale-95"
          x-transition:enter-end="opacity-100 transform translate-y-0 scale-100"
          x-transition:leave="transition ease-in duration-300"
          x-transition:leave-start="opacity-100 transform translate-y-0 scale-100"
          x-transition:leave-end="opacity-0 transform -translate-y-2 scale-95"
        >
          <div class="toast-content" x-html="toast.content"></div>
        </div>
      </template>
    </div>

    <div class="container" x-data="diceRoller()" x-init="init()" x-cloak>
      <!-- Desktop multiplayer button (top-left) -->
      <div x-show="sessionFeaturesAvailable" class="desktop-multiplayer-button">
        <button @click="toggleSessionUI()" class="multiplayer-top-btn">
          <span x-show="sessionMode === 'solo'">🎲 Play with Friends</span>
          <span x-show="sessionMode === 'multiplayer'">
            <span
              x-show="connectionStatus === 'connected'"
              :class="{ 'connection-waiting': connectionStatus === 'connected' && connectedPlayers.length === 0 }"
              >🟢</span
            >
            <span x-show="connectionStatus === 'connecting'">🟡</span>
            <span
              x-show="connectionStatus === 'disconnected' || connectionStatus === 'error'"
              >🔴</span
            >
            <span
              x-text="connectedPlayers.length === 0 ? 'Waiting for others...' : 'Playing with Friends (' + (connectedPlayers.length + 1) + ')'"
            ></span>
          </span>
        </button>
      </div>

      <div
        class="header"
        :class="{ 'no-result': !result, 'has-result': result }"
      >
        <!-- Mobile tap area for history (invisible overlay) -->
        <div
          class="mobile-history-tap-area"
          @click="showHistory = !showHistory"
        ></div>

        <!-- Logo section - shows logo-text when no result -->
        <div class="logo-container" x-show="!result">
          <img
            alt="Dagger Dice"
            src="/src/assets/daggerdice-logo-text.png"
            class="logo-text"
          />
        </div>

        <!-- Result section with inline logo -->
        <div class="result-container" x-show="result">
          <img
            alt="Dagger Dice"
            src="/src/assets/daggerdice-logo.png"
            class="logo-only"
          />
          <h1 x-html="result"></h1>
        </div>
      </div>

      <div class="dice-container">
        <div id="dice-box"></div>
      </div>

      <!-- Roll Type Selector - Outside controls for tab effect -->
      <div class="roll-type-selector desktop-controls">
        <div class="roll-type-buttons">
          <button
            @click="setRollType('check')"
            :class="{ 'active': rollType === 'check' }"
            class="roll-type-btn check-tab"
          >
            Check
          </button>
          <button
            @click="setRollType('damage')"
            :class="{ 'active': rollType === 'damage' }"
            class="roll-type-btn damage-tab"
          >
            Damage
          </button>
          <button
            @click="setRollType('gm')"
            :class="{ 'active': rollType === 'gm' }"
            class="roll-type-btn gm-tab"
          >
            GM
          </button>
        </div>
      </div>

      <!-- Desktop controls layout -->
      <div class="controls desktop-controls">
        <div class="modifiers">
          <!-- Check Roll Controls -->
          <div x-show="rollType === 'check'" class="check-controls">
            <div class="modifier-controls">
              <label>Modifier:</label>
              <button
                @click="modifier = Math.max(modifier - 1, -20)"
                class="modifier-btn"
                :disabled="isRolling"
              >
                -
              </button>
              <span class="modifier-display" x-text="modifier"></span>
              <button
                @click="modifier = Math.min(modifier + 1, 20)"
                class="modifier-btn"
                :disabled="isRolling"
              >
                +
              </button>
            </div>
            <div class="advantage-controls">
              <label>Roll Type:</label>
              <div class="toggle-buttons">
                <button
                  @click="setAdvantageType('none')"
                  :class="{ 'active': advantageType === 'none' }"
                  class="toggle-btn"
                  :disabled="isRolling"
                >
                  Standard
                </button>
                <button
                  @click="setAdvantageType('advantage')"
                  :class="{ 'active': advantageType === 'advantage' }"
                  class="toggle-btn"
                  :disabled="isRolling"
                >
                  Advantage
                </button>
                <button
                  @click="setAdvantageType('disadvantage')"
                  :class="{ 'active': advantageType === 'disadvantage' }"
                  class="toggle-btn"
                  :disabled="isRolling"
                >
                  Disadvantage
                </button>
              </div>
            </div>
          </div>

          <!-- Check Roll Clear Button -->
          <button
            @click="modifier = 0; advantageType = 'none'"
            class="modifier-clear-btn"
            x-show="rollType === 'check' && (modifier !== 0 || advantageType != 'none') && !isRolling"
            title="Clear modifiers"
          >
            🔄 Clear
          </button>

          <!-- Damage Roll Controls -->
          <div x-show="rollType === 'damage'" class="damage-controls">
            <div class="damage-main-controls">
              <div class="modifier-controls">
                <label>Modifier:</label>
                <button
                  @click="damageModifier = Math.max(damageModifier - 1, -20)"
                  class="modifier-btn"
                  :disabled="isRolling"
                >
                  -
                </button>
                <span class="modifier-display" x-text="damageModifier"></span>
                <button
                  @click="damageModifier = Math.min(damageModifier + 1, 20)"
                  class="modifier-btn"
                  :disabled="isRolling"
                >
                  +
                </button>
              </div>
              <div class="dice-selection">
                <label>Base Dice:</label>
                <div class="dice-count-controls">
                  <button
                    @click="setBaseDiceCount(baseDiceCount - 1)"
                    class="modifier-btn"
                    :disabled="isRolling"
                  >
                    -
                  </button>
                  <span class="modifier-display" x-text="baseDiceCount"></span>
                  <button
                    @click="setBaseDiceCount(baseDiceCount + 1)"
                    class="modifier-btn"
                    :disabled="isRolling"
                  >
                    +
                  </button>
                </div>
                <div class="dice-type-selector">
                  <select
                    @change="setBaseDiceType(parseInt($event.target.value))"
                    :value="baseDiceType"
                    :disabled="isRolling"
                  >
                    <option value="4">d4</option>
                    <option value="6">d6</option>
                    <option value="8">d8</option>
                    <option value="10">d10</option>
                    <option value="12">d12</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="bonus-die-controls">
              <label>
                <input
                  type="checkbox"
                  @change="toggleBonusDie()"
                  :checked="bonusDieEnabled"
                  :disabled="isRolling"
                />
                Bonus Die
              </label>
              <select
                x-show="bonusDieEnabled"
                @change="setBonusDieType(parseInt($event.target.value))"
                :value="bonusDieType"
                :disabled="isRolling"
              >
                <option value="4">d4</option>
                <option value="6">d6</option>
                <option value="8">d8</option>
                <option value="10">d10</option>
                <option value="12">d12</option>
              </select>
            </div>

            <div class="damage-options">
              <label>
                <input
                  type="checkbox"
                  @change="toggleCritical()"
                  :checked="isCritical"
                  :disabled="isRolling"
                />
                Critical
              </label>
              <label>
                <input
                  type="checkbox"
                  @change="toggleResistance()"
                  :checked="hasResistance"
                  :disabled="isRolling"
                />
                Resistance
              </label>
            </div>
          </div>

          <!-- Damage Roll Clear Button -->
          <button
            @click="damageModifier = 0; bonusDieEnabled = false; isCritical = false; hasResistance = false"
            class="modifier-clear-btn"
            x-show="rollType === 'damage' && (damageModifier !== 0 || bonusDieEnabled || isCritical || hasResistance) && !isRolling"
            title="Clear modifiers (keeps base dice)"
          >
            🔄 Clear
          </button>

          <!-- GM Roll Controls -->
          <div x-show="rollType === 'gm'" class="gm-controls">
            <div class="modifier-controls">
              <label>Modifier:</label>
              <button
                @click="gmModifier = Math.max(gmModifier - 1, -20)"
                class="modifier-btn"
                :disabled="isRolling"
              >
                -
              </button>
              <span class="modifier-display" x-text="gmModifier"></span>
              <button
                @click="gmModifier = Math.min(gmModifier + 1, 20)"
                class="modifier-btn"
                :disabled="isRolling"
              >
                +
              </button>
            </div>
            <!-- GM Advantage/Disadvantage Controls -->
            <div class="advantage-controls">
              <label>Roll Type:</label>
              <div class="toggle-buttons">
                <button
                  @click="setGMAdvantageType('none')"
                  :class="{ 'active': gmAdvantageType === 'none' }"
                  class="toggle-btn"
                  :disabled="isRolling"
                >
                  Standard
                </button>
                <button
                  @click="setGMAdvantageType('advantage')"
                  :class="{ 'active': gmAdvantageType === 'advantage' }"
                  class="toggle-btn"
                  :disabled="isRolling"
                >
                  Advantage
                </button>
                <button
                  @click="setGMAdvantageType('disadvantage')"
                  :class="{ 'active': gmAdvantageType === 'disadvantage' }"
                  class="toggle-btn"
                  :disabled="isRolling"
                >
                  Disadvantage
                </button>
              </div>
            </div>
            <!-- Private Rolls Checkbox (multiplayer only) -->
            <div x-show="sessionMode === 'multiplayer'" class="gm-options">
              <label>
                <input
                  type="checkbox"
                  x-model="gmPrivateRolls"
                  :disabled="isRolling"
                />
                Private rolls
              </label>
            </div>
          </div>

          <!-- GM Roll Clear Button -->
          <button
            @click="gmModifier = 0; setGMAdvantageType('none')"
            class="modifier-clear-btn"
            x-show="rollType === 'gm' && (gmModifier !== 0 || gmAdvantageType !== 'none') && !isRolling"
            title="Clear GM modifiers"
          >
            🔄 Clear
          </button>
        </div>

        <button @click="rollDice()" :disabled="isRolling" class="roll-button">
          <span x-text="isRolling ? 'Rolling...' : 'Roll Dice'"></span>
        </button>
      </div>

      <!-- Mobile bottom bar -->
      <div
        class="mobile-bottom-bar"
        x-data="{ showModifiers: false, showActions: false }"
      >
        <!-- Mobile Roll Type Tab Selector (at top of bottom area) -->
        <div class="roll-type-selector mobile-controls">
          <div class="roll-type-buttons">
            <button
              @click="setRollType('check')"
              :class="{ 'active': rollType === 'check' }"
              class="roll-type-btn check-tab"
            >
              Check
            </button>
            <button
              @click="setRollType('damage')"
              :class="{ 'active': rollType === 'damage' }"
              class="roll-type-btn damage-tab"
            >
              Damage
            </button>
            <button
              @click="setRollType('gm')"
              :class="{ 'active': rollType === 'gm' }"
              class="roll-type-btn gm-tab"
            >
              GM
            </button>
          </div>
        </div>

        <!-- Mobile base dice controls (shown below damage tab) -->
        <div
          class="mobile-base-dice-controls"
          x-show="rollType === 'damage'"
          x-transition:enter="transition ease-out duration-200"
          x-transition:enter-start="opacity-0 transform -translate-y-2"
          x-transition:enter-end="opacity-100 transform translate-y-0"
          x-transition:leave="transition ease-in duration-200"
          x-transition:leave-start="opacity-100 transform translate-y-0"
          x-transition:leave-end="opacity-0 transform -translate-y-2"
        >
          <div class="base-dice-row">
            <div class="dice-count-controls">
              <button
                @click="setBaseDiceCount(baseDiceCount - 1)"
                class="dice-control-btn"
                :disabled="isRolling"
              >
                -
              </button>
              <span class="dice-count-display" x-text="baseDiceCount"></span>
              <button
                @click="setBaseDiceCount(baseDiceCount + 1)"
                class="dice-control-btn"
                :disabled="isRolling"
              >
                +
              </button>
            </div>
            <select
              @change="setBaseDiceType(parseInt($event.target.value))"
              :value="baseDiceType"
              class="mobile-dice-select"
              :disabled="isRolling"
            >
              <option value="4">d4</option>
              <option value="6">d6</option>
              <option value="8">d8</option>
              <option value="10">d10</option>
              <option value="12">d12</option>
            </select>
          </div>
        </div>

        <!-- Bottom button bar -->
        <div class="bottom-button-bar">
          <!-- Left: Modifiers Button -->
          <div class="bottom-left">
            <button
              @click="toggleModifiersDialog()"
              class="bottom-section-btn"
              :class="{ 'active': showModifiers }"
              title="Modifiers"
            >
              <div class="section-btn-content">
                <img
                  src="/assets/icons/gear.png"
                  alt="Mods"
                  class="section-btn-icon"
                />
                <span class="section-btn-text">Mods</span>
                <span
                  class="section-btn-value"
                  x-show="(rollType === 'check' && (modifier !== 0 || advantageType !== 'none')) || (rollType === 'gm' && (gmModifier !== 0 || gmAdvantageType !== 'none')) || (rollType === 'damage' && (damageModifier !== 0 || bonusDieEnabled || isCritical || hasResistance))"
                >
                  <!-- Check roll modifiers -->
                  <template x-if="rollType === 'check'">
                    <span>
                      <span x-show="advantageType === 'advantage'">A</span>
                      <span x-show="advantageType === 'disadvantage'">D</span>
                      <span x-show="modifier > 0"
                        >+<span x-text="modifier"></span
                      ></span>
                      <span x-show="modifier < 0" x-text="modifier"></span>
                    </span>
                  </template>
                  <!-- GM roll modifiers -->
                  <template x-if="rollType === 'gm'">
                    <span>
                      <span x-show="gmAdvantageType === 'advantage'">A</span>
                      <span x-show="gmAdvantageType === 'disadvantage'">D</span>
                      <span x-show="gmModifier > 0"
                        >+<span x-text="gmModifier"></span
                      ></span>
                      <span x-show="gmModifier < 0" x-text="gmModifier"></span>
                    </span>
                  </template>
                  <!-- Damage roll modifiers -->
                  <template x-if="rollType === 'damage'">
                    <span>
                      <span x-show="damageModifier > 0"
                        >+<span x-text="damageModifier"></span
                      ></span>
                      <span x-show="damageModifier < 0" x-text="damageModifier"></span>
                      <span x-show="bonusDieEnabled"
                        >+d<span x-text="bonusDieType"></span
                      ></span>
                      <span x-show="isCritical"> C</span>
                      <span x-show="hasResistance"> R</span>
                    </span>
                  </template>
                </span>
              </div>
            </button>
          </div>

          <!-- Center: Roll Button -->
          <div class="bottom-center">
            <div class="roll-button-container">
              <button
                @click="rollDice()"
                :disabled="isRolling"
                class="bottom-roll-button"
              >
                <span x-text="isRolling ? 'Rolling...' : 'Roll'"></span>
              </button>
              <!-- Multiplayer indicator when connected -->
              <button
                x-show="sessionMode === 'multiplayer' && sessionFeaturesAvailable"
                @click="toggleSessionUI()"
                class="multiplayer-indicator"
                :class="connectionStatus"
                title="Multiplayer Session"
              >
                <span
                  x-show="connectionStatus === 'connected'"
                  :class="{ 'connection-waiting': connectionStatus === 'connected' && connectedPlayers.length === 0 }"
                  >🟢</span
                >
                <span x-show="connectionStatus === 'connecting'">🟡</span>
                <span
                  x-show="connectionStatus === 'disconnected' || connectionStatus === 'error'"
                  >🔴</span
                >
                <span
                  x-show="connectedPlayers.length > 0"
                  class="player-count"
                  x-text="connectedPlayers.length + 1"
                ></span>
              </button>
            </div>
          </div>

          <!-- Right: Actions Button -->
          <div class="bottom-right">
            <button
              @click="toggleActionsDialog()"
              class="bottom-section-btn"
              :class="{ 'active': showActions }"
              title="History & Multiplayer"
            >
              <div class="section-btn-content">
                <img
                  src="/assets/icons/more.png"
                  alt="More"
                  class="section-btn-icon"
                />
                <span class="section-btn-text">More</span>
              </div>
            </button>
          </div>
        </div>

        <!-- Left Dialog: Modifiers -->
        <div
          class="mobile-dialog mobile-dialog-left"
          :class="{ 'visible': showModifiers }"
          x-show="showModifiers"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="transform translate-y-full"
          x-transition:enter-end="transform translate-y-0"
          x-transition:leave="transition ease-in duration-300"
          x-transition:leave-start="transform translate-y-0"
          x-transition:leave-end="transform translate-y-full"
        >
          <div class="dialog-header">
            <h3>Modifiers</h3>
            <button @click="showModifiers = false" class="dialog-close">
              ✕
            </button>
          </div>

          <div class="dialog-content">
            <!-- Check Roll Controls -->
            <div x-show="rollType === 'check'">
              <!-- Clear button for Check rolls -->
              <div class="dialog-section">
                <button
                  @click="modifier = 0; advantageType = 'none'; showModifiers = false"
                  class="clear-all-btn"
                  x-show="modifier !== 0 || advantageType !== 'none'"
                  title="Clear all modifiers"
                >
                  🔄 Clear
                </button>
              </div>

              <!-- Numeric modifier controls -->
              <div class="dialog-section">
                <label>Numeric Modifier:</label>
                <div class="modifier-controls-dialog">
                  <button
                    @click="modifier = Math.max(modifier - 1, -20)"
                    class="modifier-btn-dialog"
                    title="Decrease modifier"
                    :disabled="isRolling"
                  >
                    -
                  </button>
                  <span
                    class="modifier-display-dialog"
                    x-text="modifier"
                  ></span>
                  <button
                    @click="modifier = Math.min(modifier + 1, 20)"
                    class="modifier-btn-dialog"
                    title="Increase modifier"
                    :disabled="isRolling"
                  >
                    +
                  </button>
                </div>
              </div>

              <!-- Advantage/Disadvantage controls -->
              <div class="dialog-section">
                <label>Roll Type:</label>
                <div class="toggle-buttons">
                  <button
                    @click="setAdvantageType('none')"
                    :class="{ 'active': advantageType === 'none' }"
                    class="toggle-btn"
                    :disabled="isRolling"
                  >
                    Standard
                  </button>
                  <button
                    @click="setAdvantageType('advantage')"
                    :class="{ 'active': advantageType === 'advantage' }"
                    class="toggle-btn"
                    :disabled="isRolling"
                  >
                    Advantage
                  </button>
                  <button
                    @click="setAdvantageType('disadvantage')"
                    :class="{ 'active': advantageType === 'disadvantage' }"
                    class="toggle-btn"
                    :disabled="isRolling"
                  >
                    Disadvantage
                  </button>
                </div>
              </div>
            </div>

            <!-- Damage Roll Controls -->
            <div x-show="rollType === 'damage'">
              <!-- Clear button for Damage rolls -->
              <div class="dialog-section">
                <button
                  @click="damageModifier = 0; bonusDieEnabled = false; isCritical = false; hasResistance = false"
                  class="clear-all-btn"
                  x-show="damageModifier !== 0 || bonusDieEnabled || isCritical || hasResistance"
                  title="Clear options (keeps base dice)"
                >
                  🔄 Clear
                </button>
              </div>

              <!-- Damage modifier controls -->
              <div class="dialog-section">
                <label>Flat Modifier:</label>
                <div class="modifier-controls-dialog">
                  <button
                    @click="damageModifier = Math.max(damageModifier - 1, -20)"
                    class="modifier-btn-dialog"
                    title="Decrease modifier"
                    :disabled="isRolling"
                  >
                    -
                  </button>
                  <span
                    class="modifier-display-dialog"
                    x-text="damageModifier"
                  ></span>
                  <button
                    @click="damageModifier = Math.min(damageModifier + 1, 20)"
                    class="modifier-btn-dialog"
                    title="Increase modifier"
                    :disabled="isRolling"
                  >
                    +
                  </button>
                </div>
              </div>

              <div class="dialog-section">
                <label>
                  <input
                    type="checkbox"
                    @change="toggleBonusDie()"
                    :checked="bonusDieEnabled"
                    :disabled="isRolling"
                  />
                  Bonus Die
                </label>
                <select
                  x-show="bonusDieEnabled"
                  @change="setBonusDieType(parseInt($event.target.value))"
                  :value="bonusDieType"
                  class="dice-select"
                  :disabled="isRolling"
                >
                  <option value="4">d4</option>
                  <option value="6">d6</option>
                  <option value="8">d8</option>
                  <option value="10">d10</option>
                  <option value="12">d12</option>
                </select>
              </div>

              <div class="dialog-section">
                <label>
                  <input
                    type="checkbox"
                    @change="toggleCritical()"
                    :checked="isCritical"
                    :disabled="isRolling"
                  />
                  Critical Hit
                </label>
                <label>
                  <input
                    type="checkbox"
                    @change="toggleResistance()"
                    :checked="hasResistance"
                    :disabled="isRolling"
                  />
                  Resistance
                </label>
              </div>
            </div>

            <!-- GM Roll Controls -->
            <div x-show="rollType === 'gm'">
              <!-- Clear button for GM rolls -->
              <div class="dialog-section">
                <button
                  @click="gmModifier = 0; setGMAdvantageType('none'); showModifiers = false"
                  class="clear-all-btn"
                  x-show="gmModifier !== 0 || gmAdvantageType !== 'none'"
                  title="Clear GM modifiers"
                >
                  🔄 Clear
                </button>
              </div>

              <div class="dialog-section">
                <label>D20 Modifier:</label>
                <div class="modifier-controls-dialog">
                  <button
                    @click="gmModifier = Math.max(gmModifier - 1, -20)"
                    class="modifier-btn-dialog"
                    title="Decrease modifier"
                    :disabled="isRolling"
                  >
                    -
                  </button>
                  <span
                    class="modifier-display-dialog"
                    x-text="gmModifier"
                  ></span>
                  <button
                    @click="gmModifier = Math.min(gmModifier + 1, 20)"
                    class="modifier-btn-dialog"
                    title="Increase modifier"
                    :disabled="isRolling"
                  >
                    +
                  </button>
                </div>
              </div>
              <!-- GM Advantage/Disadvantage Controls -->
              <div class="dialog-section">
                <label>Roll Type:</label>
                <div class="toggle-buttons">
                  <button
                    @click="setGMAdvantageType('none')"
                    :class="{ 'active': gmAdvantageType === 'none' }"
                    class="toggle-btn"
                    :disabled="isRolling"
                  >
                    Standard
                  </button>
                  <button
                    @click="setGMAdvantageType('advantage')"
                    :class="{ 'active': gmAdvantageType === 'advantage' }"
                    class="toggle-btn"
                    :disabled="isRolling"
                  >
                    Advantage
                  </button>
                  <button
                    @click="setGMAdvantageType('disadvantage')"
                    :class="{ 'active': gmAdvantageType === 'disadvantage' }"
                    class="toggle-btn"
                    :disabled="isRolling"
                  >
                    Disadvantage
                  </button>
                </div>
              </div>
              <!-- Private Rolls Checkbox (multiplayer only) -->
              <div
                x-show="sessionMode === 'multiplayer'"
                class="dialog-section"
              >
                <div class="dialog-checkbox-group">
                  <label class="dialog-checkbox-label">
                    <input
                      type="checkbox"
                      x-model="gmPrivateRolls"
                      :disabled="isRolling"
                    />
                    Private rolls
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Dialog: Actions (History & Multiplayer) -->
        <div
          class="mobile-dialog mobile-dialog-right"
          :class="{ 'visible': showActions }"
          x-show="showActions"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="transform translate-y-full"
          x-transition:enter-end="transform translate-y-0"
          x-transition:leave="transition ease-in duration-300"
          x-transition:leave-start="transform translate-y-0"
          x-transition:leave-end="transform translate-y-full"
        >
          <div class="dialog-header">
            <h3>Actions</h3>
            <button @click="showActions = false" class="dialog-close">✕</button>
          </div>

          <div class="dialog-content">
            <!-- History section -->
            <div class="dialog-section">
              <button
                class="action-btn"
                @click="showHistory = true; showActions = false"
                title="Show Roll History"
              >
                <img
                  src="/src/assets/history.svg"
                  alt="History"
                  class="action-btn-icon"
                />
                <span>Roll History</span>
              </button>
            </div>

            <!-- Multiplayer section -->
            <div class="dialog-section" x-show="sessionFeaturesAvailable">
              <button
                class="action-btn"
                @click="toggleSessionUI(); showActions = false"
                title="Multiplayer Options"
              >
                <span class="action-btn-icon">
                  <span x-show="sessionMode === 'solo'">🎲</span>
                  <span x-show="sessionMode === 'multiplayer'">
                    <span
                      x-show="connectionStatus === 'connected'"
                      :class="{ 'connection-waiting': connectionStatus === 'connected' && connectedPlayers.length === 0 }"
                      >🟢</span
                    >
                    <span x-show="connectionStatus === 'connecting'">🟡</span>
                    <span
                      x-show="connectionStatus === 'disconnected' || connectionStatus === 'error'"
                      >🔴</span
                    >
                  </span>
                </span>
                <span x-show="sessionMode === 'solo'">Play with Friends</span>
                <span x-show="sessionMode === 'multiplayer'">
                  <span
                    x-text="connectedPlayers.length === 0 ? 'Waiting for others...' : 'Playing with Friends (' + (connectedPlayers.length + 1) + ')'"
                  ></span>
                </span>
              </button>
            </div>

            <!-- Version info with GitHub link -->
            <div class="version-info">
              <a
                href="https://github.com/SmileyChris/daggerdice"
                target="_blank"
                rel="noopener noreferrer"
                class="github-link-mobile"
                title="View on GitHub"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
                  />
                </svg>
              </a>
              <span x-text="appVersion"></span>
            </div>
          </div>
        </div>

        <!-- Backdrop to close dialogs -->
        <div
          class="dialog-backdrop"
          x-show="showModifiers || showActions"
          @click="showModifiers = false; showActions = false"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0"
          x-transition:enter-end="opacity-100"
          x-transition:leave="transition ease-in duration-300"
          x-transition:leave-start="opacity-100"
          x-transition:leave-end="opacity-0"
        ></div>
      </div>

      <!-- Unified Session Panel -->
      <div
        class="session-panel"
        :class="{ 'visible': showSessionUI && sessionFeaturesAvailable }"
        @keydown.escape.window="showSessionUI && toggleSessionUI()"
      >
        <div class="dialog-header">
          <h3 x-show="sessionMode === 'solo'">Multiplayer Room</h3>
          <div x-show="sessionMode === 'multiplayer'" class="room-title">
            <div class="room-name-line" x-show="!effectiveStreamerMode">
              <span
                class="room-friendly-name"
                x-text="formattedRoomName"
              ></span>
            </div>
            <div class="room-code-line">
              <div x-show="!effectiveStreamerMode">
                <span class="room-code-label">Code:</span>
                <span class="room-code" x-text="sessionShortCode"></span>
              </div>
              <div x-show="effectiveStreamerMode">
                <span
                  class="room-hidden"
                  @click="temporarilyShowRoomDetails()"
                  title="Click to temporarily reveal room details"
                  >🙈 Room Hidden</span
                >
              </div>
              <div class="connection-status" :class="connectionStatus">
                <span x-show="connectionStatus === 'connected'"
                  >🟢 Connected</span
                >
                <span x-show="connectionStatus === 'connecting'"
                  >🟡 Connecting...</span
                >
                <span x-show="connectionStatus === 'disconnected'"
                  >🔴 Disconnected</span
                >
                <span x-show="connectionStatus === 'error'">❌ Error</span>
              </div>
            </div>
          </div>
          <button @click="toggleSessionUI()" class="dialog-close">✕</button>
        </div>

        <div class="dialog-content">
          <!-- Solo mode: session creation/joining -->
          <form
            x-show="sessionMode === 'solo'"
            class="session-join"
            autocomplete="off"
            @submit.prevent="(!playerName.trim() || connectionStatus === 'connecting' || !isJoinSessionValid) ? null : (joinSessionId.trim() ? joinSession() : createSession())"
          >
            <div class="session-input">
              <input
                x-model="playerName"
                placeholder="Your name"
                required
                maxlength="20"
                class="player-name-input"
              />
            </div>

            <div class="streamer-mode-toggle">
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  @change="toggleStreamerMode()"
                  :checked="streamerMode"
                />
                <span class="toggle-slider"></span>
                <span class="toggle-label">Hide Room Details</span>
              </label>
            </div>

            <div class="session-input">
              <input
                x-model="joinSessionId"
                placeholder="Room ID or room link (optional)"
                class="session-id-input"
                :type="effectiveStreamerMode ? 'password' : 'search'"
                autocomplete="new-password"
                @input="handleRoomIdChange()"
                @paste="setTimeout(() => handleRoomIdChange(), 0)"
              />
            </div>

            <div class="session-action">
              <button
                type="submit"
                :disabled="!playerName.trim() || connectionStatus === 'connecting' || !isJoinSessionValid"
                class="session-btn primary-btn"
              >
                <span x-show="connectionStatus === 'connecting'">
                  <span
                    x-text="joinSessionId.trim() ? 'Joining...' : 'Creating...'"
                  ></span>
                </span>
                <span x-show="connectionStatus !== 'connecting'">
                  <span
                    x-text="joinSessionId.trim() ? 'Join Room' : 'Create New Room'"
                  ></span>
                </span>
              </button>
            </div>

            <div x-show="connectionStatus === 'error'" class="session-error">
              Connection failed. Please try again.
            </div>
          </form>

          <!-- Multiplayer mode: room info -->
          <div x-show="sessionMode === 'multiplayer'" class="session-info">
            <!-- QR Code in top right -->
            <div
              class="qr-code-float"
              x-show="sessionId && !effectiveStreamerMode"
            >
              <img
                :src="generateQRCode(sessionId)"
                alt="QR Code to join room"
                class="qr-code"
                x-show="sessionId"
                title="Scan to join room"
              />
            </div>

            <!-- Copy link controls -->
            <div class="room-controls">
              <button
                @click="copySessionLink()"
                class="copy-btn"
                title="Copy room link"
                x-show="!effectiveStreamerMode"
              >
                📋 Copy Link
              </button>
            </div>

            <!-- Players list -->
            <div class="players-section">
              <h4>
                Players (<span x-text="connectedPlayers.length + 1"></span>)
              </h4>

              <div class="players-list">
                <div class="player-item self">
                  <span x-text="playerName + ' (you)'"></span>
                </div>
                <template x-for="player in connectedPlayers" :key="player.id">
                  <div class="player-item">
                    <span x-text="player.name"></span>
                    <span x-show="!player.isActive" class="inactive"
                      >(away)</span
                    >
                  </div>
                </template>
              </div>
            </div>

            <div class="session-actions">
              <button
                @click="toggleSessionUI()"
                class="session-btn secondary-btn desktop-only"
              >
                OK
              </button>
              <button @click="leaveSession()" class="session-btn leave-btn">
                Leave Room
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Session panel backdrop -->
      <div
        class="dialog-backdrop session-backdrop"
        :class="{ 'visible': showSessionUI && sessionFeaturesAvailable }"
        @click="toggleSessionUI()"
      ></div>

      <button
        class="history-toggle"
        @click="toggleHistory()"
        x-show="rollHistory.length > 0"
      >
        <img src="/src/assets/history.svg" alt="History" class="history-icon" />
      </button>

      <!-- Unified Roll History Dialog -->
      <div class="roll-history-panel" :class="{ 'visible': showHistory }">
        <div class="dialog-header">
          <h3>Roll History</h3>
          <button @click="showHistory = false" class="dialog-close">✕</button>
        </div>

        <div class="dialog-content">
          <div x-show="rollHistory.length === 0" class="empty-history">
            No rolls yet. Roll some dice to see your history!
          </div>
          <div x-show="rollHistory.length > 0" class="history-list">
            <template
              x-for="(roll, index) in rollHistory.slice(0, 10)"
              :key="index"
            >
              <div
                class="history-item"
                :class="'roll-type-' + (roll.rollType || 'check')"
              >
                <!-- Player name on separate line for multiplayer -->
                <div
                  x-show="sessionMode === 'multiplayer' && roll.playerName"
                  class="player-name-line"
                >
                  <span x-text="roll.playerName"></span>
                </div>

                <div class="roll-details">
                  <!-- Main result line -->
                  <div class="main-result">
                    <span class="result-text">
                      <template
                        x-if="!roll.rollType || roll.rollType === 'check'"
                      >
                        <span>
                          <template
                            x-if="roll.result.includes('Critical Success')"
                          >
                            <span><strong>Critical Success!</strong></span>
                          </template>
                          <template
                            x-if="!roll.result.includes('Critical Success')"
                          >
                            <span>
                              <strong x-text="roll.total"></strong>
                              <span
                                x-text="roll.result.includes('hope') ? ' with hope' : ' with fear'"
                              ></span>
                            </span>
                          </template>
                        </span>
                      </template>
                      <template x-if="roll.rollType === 'damage'">
                        <span
                          ><strong x-text="roll.total"></strong> damage</span
                        >
                      </template>
                      <template x-if="roll.rollType === 'gm'">
                        <span><strong x-text="roll.total"></strong> GM</span>
                      </template>
                    </span>
                  </div>

                  <!-- Details line -->
                  <div class="roll-breakdown">
                    <!-- Check Roll Details -->
                    <template
                      x-if="!roll.rollType || roll.rollType === 'check'"
                    >
                      <span class="breakdown-text">
                        <span x-text="roll.hopeValue"></span> Hope,
                        <span x-text="roll.fearValue"></span> Fear<span
                          x-show="roll.advantageValue && roll.advantageValue !== 0"
                          >,
                          <span x-text="Math.abs(roll.advantageValue)"></span>
                          <span
                            x-text="roll.advantageValue > 0 ? 'Adv.' : 'Disadv.'"
                          ></span></span
                        ><span
                          x-show="roll.modifier !== undefined && roll.modifier !== 0"
                          >,
                          <span
                            x-text="(roll.modifier > 0 ? '+' : '') + roll.modifier"
                          ></span
                        ></span>
                      </span>
                    </template>

                    <!-- Damage Roll Details -->
                    <template x-if="roll.rollType === 'damage'">
                      <span class="breakdown-text">
                        <span
                          x-text="roll.baseDiceCount + 'd' + roll.baseDiceType"
                        ></span>
                        <span
                          x-show="roll.baseDiceValues && roll.baseDiceValues.length > 0"
                        >
                          (<span x-text="roll.baseDiceValues.join(', ')"></span
                          >) </span
                        ><span
                          x-show="roll.bonusDieEnabled && roll.bonusDieValue !== undefined"
                          >, Bonus d<span x-text="roll.bonusDieType"></span>
                          (<span x-text="roll.bonusDieValue"></span>)</span
                        ><span
                          x-show="roll.damageModifier !== undefined && roll.damageModifier !== 0"
                          >, Modifier:
                          <span
                            x-text="(roll.damageModifier > 0 ? '+' : '') + roll.damageModifier"
                          ></span
                        ></span
                        ><span x-show="roll.isCritical"
                          >, <span class="critical-text">Critical</span></span
                        ><span x-show="roll.hasResistance"
                          >,
                          <span class="resistance-text">Resistance</span></span
                        >
                      </span>
                    </template>

                    <!-- GM Roll Details -->
                    <template x-if="roll.rollType === 'gm'">
                      <span class="breakdown-text">
                        <span x-show="roll.gmAdvantageType === 'none'">
                          <span x-text="roll.d20Value"></span>
                        </span>
                        <span x-show="roll.gmAdvantageType !== 'none'">
                          <span x-text="roll.d20Value"></span> and
                          <span x-text="roll.d20Value2"></span> w/
                          <span
                            x-text="roll.gmAdvantageType === 'advantage' ? 'Adv.' : 'Dis.'"
                          ></span>
                        </span>
                        <span x-show="roll.gmModifier !== 0"
                          >, Modifier:
                          <span
                            x-text="(roll.gmModifier > 0 ? '+' : '') + roll.gmModifier"
                          ></span
                        ></span>
                        <span x-show="roll.gmPrivate"> (private)</span>
                      </span>
                    </template>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Keyboard Shortcuts Help Dialog -->
      <div
        class="keyboard-help-overlay"
        x-show="showKeyboardHelp"
        @click.self="showKeyboardHelp = false"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
      >
        <div class="keyboard-help-dialog">
          <div class="keyboard-help-header">
            <h3>Keyboard Shortcuts</h3>
            <button
              @click="showKeyboardHelp = false"
              class="close-dialog-btn"
              title="Close"
            >
              ✕
            </button>
          </div>

          <div class="keyboard-help-content">
            <div class="shortcut-section">
              <h4>Roll Types</h4>
              <div class="shortcut-item">
                <kbd>C</kbd>
                <span>Switch to Check rolls</span>
              </div>
              <div class="shortcut-item">
                <kbd>D</kbd>
                <span>Switch to Damage rolls</span>
              </div>
              <div class="shortcut-item">
                <kbd>G</kbd>
                <span>Switch to GM rolls</span>
              </div>
            </div>

            <div class="shortcut-section">
              <h4>Modifiers</h4>
              <div class="shortcut-item">
                <kbd>←</kbd>
                <span>Decrease modifier</span>
              </div>
              <div class="shortcut-item">
                <kbd>→</kbd>
                <span>Increase modifier</span>
              </div>
              <div class="shortcut-item">
                <kbd>+</kbd>
                <span>Increase dice count (Damage)</span>
              </div>
              <div class="shortcut-item">
                <kbd>-</kbd>
                <span>Decrease dice count (Damage)</span>
              </div>
              <div class="shortcut-item">
                <kbd>↑</kbd>
                <span>Increase dice type (Damage)</span>
              </div>
              <div class="shortcut-item">
                <kbd>↓</kbd>
                <span>Decrease dice type (Damage)</span>
              </div>
            </div>

            <div class="shortcut-section">
              <h4>Actions</h4>
              <div class="shortcut-item">
                <kbd>Space</kbd>
                <span>Roll dice</span>
              </div>
              <div class="shortcut-item">
                <kbd>H</kbd>
                <span>Toggle roll history</span>
              </div>
              <div class="shortcut-item">
                <kbd>M</kbd>
                <span>Toggle multiplayer panel</span>
              </div>
              <div class="shortcut-item">
                <kbd>?</kbd>
                <span>Show this help</span>
              </div>
              <div class="shortcut-item">
                <kbd>Esc</kbd>
                <span>Close dialogs</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Desktop GitHub link -->
      <div class="desktop-github-link">
        <a
          href="https://github.com/SmileyChris/daggerdice"
          target="_blank"
          rel="noopener noreferrer"
          title="View on GitHub"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
            />
          </svg>
        </a>
      </div>

      <!-- Desktop version display -->
      <div class="desktop-version-display">
        <span x-text="appVersion"></span>
      </div>
    </div>

    <!-- Import the built JavaScript module -->
    <script type="module" src="/src/dice-roller-main.ts"></script>
  </body>
</html>
