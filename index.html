<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/src/assets/favicon.png" />
    <title>DaggerDice</title>
  </head>
  <body>
    <div class="container" x-data="diceRoller()" x-init="init()" x-cloak>
      <div class="header">
        <!-- Logo section - shows logo-text when no result, just logo when there's a result -->
        <div class="logo-container" :class="{ 'has-result': result }">
          <img
            alt="Dagger Dice"
            src="/src/assets/daggerdice-logo-text.png"
            class="logo-text"
            x-show="!result"
          />
          <img
            alt="Dagger Dice"
            src="/src/assets/daggerdice-logo.png"
            class="logo-only"
            x-show="result"
          />
        </div>

        <!-- Result section -->
        <div class="result-container" x-show="result">
          <h1 x-html="result"></h1>
        </div>
      </div>

      <div class="dice-container">
        <div id="dice-box"></div>
      </div>

      <div class="controls">
        <div class="modifiers">
          <div class="advantage-controls">
            <label>Roll Type:</label>
            <div class="toggle-buttons">
              <button
                @click="setAdvantageType('none')"
                :class="{ 'active': advantageType === 'none' }"
                class="toggle-btn"
                :disabled="isRolling"
              >
                Standard
              </button>
              <button
                @click="setAdvantageType('advantage')"
                :class="{ 'active': advantageType === 'advantage' }"
                class="toggle-btn"
                :disabled="isRolling"
              >
                Advantage
              </button>
              <button
                @click="setAdvantageType('disadvantage')"
                :class="{ 'active': advantageType === 'disadvantage' }"
                class="toggle-btn"
                :disabled="isRolling"
              >
                Disadvantage
              </button>
            </div>
          </div>

          <button
            @click="modifier = 0; advantageType = 'none'"
            class="modifier-clear-btn"
            x-show="(modifier !== 0 || advantageType != 'none') && !isRolling"
            title="Clear modifiers"
          >
            √ó
          </button>

          <div class="modifier-controls">
            <label>Modifier:</label>
            <button
              @click="modifier = Math.max(modifier - 1, -20)"
              class="modifier-btn"
            >
              -
            </button>
            <span class="modifier-display" x-text="modifier"></span>
            <button
              @click="modifier = Math.min(modifier + 1, 20)"
              class="modifier-btn"
            >
              +
            </button>
          </div>
        </div>

        <button @click="rollDice()" :disabled="isRolling" class="roll-button">
          <span x-text="isRolling ? 'Rolling...' : 'Roll Dice'"></span>
        </button>
      </div>

      <!-- ===== NEW: OPTIONAL SESSION PANEL ===== -->
      <div x-show="sessionFeaturesAvailable" class="session-toggle-container">
        <button @click="toggleSessionUI()" class="session-toggle-btn">
          <span x-show="sessionMode === 'solo'">üé≤ Play with Friends</span>
          <span x-show="sessionMode === 'multiplayer'">üë§ Solo Mode</span>
        </button>
      </div>

      <div x-show="showSessionUI && sessionFeaturesAvailable" class="session-panel">
        <!-- Solo mode: session creation/joining -->
        <div x-show="sessionMode === 'solo'" class="session-join">
          <h3>Multiplayer Session</h3>
          
          <div class="session-input">
            <input 
              x-model="playerName" 
              placeholder="Your name" 
              required 
              maxlength="20"
              class="player-name-input"
            >
          </div>
          
          <div class="create-session">
            <button 
              @click="createSession()" 
              :disabled="!playerName.trim() || connectionStatus === 'connecting'"
              class="session-btn create-btn"
            >
              <span x-show="connectionStatus !== 'connecting'">Create New Session</span>
              <span x-show="connectionStatus === 'connecting'">Creating...</span>
            </button>
          </div>
          
          <div class="join-divider">or</div>
          
          <div class="join-session">
            <input 
              x-model="joinSessionId" 
              placeholder="Session ID"
              class="session-id-input"
            >
            <button 
              @click="joinSession()" 
              :disabled="!joinSessionId.trim() || !playerName.trim() || connectionStatus === 'connecting'"
              class="session-btn join-btn"
            >
              <span x-show="connectionStatus !== 'connecting'">Join Session</span>
              <span x-show="connectionStatus === 'connecting'">Joining...</span>
            </button>
          </div>
          
          <div x-show="connectionStatus === 'error'" class="session-error">
            Connection failed. Please try again.
          </div>
        </div>

        <!-- Multiplayer mode: session info -->
        <div x-show="sessionMode === 'multiplayer'" class="session-info">
          <div class="session-details">
            <div class="session-id-display">
              <strong>Session:</strong> 
              <span x-text="sessionId" class="session-id"></span>
              <button 
                @click="copySessionLink()" 
                class="copy-btn"
                title="Copy session link"
              >
                üìã
              </button>
            </div>
            
            <div class="connection-status" :class="connectionStatus">
              <span x-show="connectionStatus === 'connected'">üü¢ Connected</span>
              <span x-show="connectionStatus === 'connecting'">üü° Connecting...</span>
              <span x-show="connectionStatus === 'disconnected'">üî¥ Disconnected</span>
              <span x-show="connectionStatus === 'error'">‚ùå Error</span>
            </div>
          </div>
          
          <div class="players-list">
            <strong>Players (<span x-text="connectedPlayers.length + 1"></span>):</strong>
            <div class="players-container">
              <div class="player-item self">
                <span x-text="playerName + ' (you)'"></span>
              </div>
              <template x-for="player in connectedPlayers" :key="player.id">
                <div class="player-item">
                  <span x-text="player.name"></span>
                  <span x-show="!player.isActive" class="inactive">(away)</span>
                </div>
              </template>
            </div>
          </div>
          
          <button @click="leaveSession()" class="session-btn leave-btn">
            Leave Session
          </button>
        </div>
      </div>

      <button
        class="history-toggle"
        @click="toggleHistory()"
        x-show="rollHistory.length || true"
      >
        <img src="/src/assets/history.svg" alt="History" class="history-icon" />
      </button>

      <div
        class="roll-history-panel"
        :class="{ 'visible': showHistory }"
        x-show="rollHistory.length > 0"
      >
        <div class="roll-history">
          <h3>Roll History</h3>
          <template
            x-for="(roll, index) in rollHistory.slice(0, 10)"
            :key="index"
          >
            <div class="history-item">
              <!-- Show player name in multiplayer mode -->
              <div x-show="sessionMode === 'multiplayer' && roll.playerName" class="player-name-tag">
                <span x-text="roll.playerName"></span>
              </div>
              
              <div class="dice-values">
                <span class="hope" x-text="roll.hope"></span>
                <span class="fear" x-text="roll.fear"></span>
                <span
                  x-show="roll.advantage !== 0"
                  :class="roll.advantage > 0 ? 'advantage' : 'disadvantage'"
                  x-text="(roll.advantage > 0 ? '+' : '') + roll.advantage"
                ></span>
                <span
                  x-show="roll.modifier !== 0"
                  x-text="(roll.modifier > 0 ? '+' : '') + roll.modifier"
                ></span>
              </div>
              <div class="outcome">
                <template x-if="!roll.result.includes('Critical')">
                  <strong x-text="roll.total"></strong>
                </template>
                <small
                  x-text="roll.result.includes('hope') ? 'hope' : roll.result.includes('fear') ? 'fear' : 'crit'"
                ></small>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- Import the built JavaScript module -->
    <script type="module" src="/src/dice-roller-main.ts"></script>
  </body>
</html>
