<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/src/assets/favicon.png" />
    <title>DaggerDice</title>
  </head>
  <body>
    <!-- Toast container -->
    <div class="toast-container" x-data="toastManager()" x-init="init()">
      <template x-for="toast in toasts" :key="toast.id">
        <div
          class="toast"
          :class="toast.type"
          x-show="toast.visible"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0 transform -translate-y-2 scale-95"
          x-transition:enter-end="opacity-100 transform translate-y-0 scale-100"
          x-transition:leave="transition ease-in duration-300"
          x-transition:leave-start="opacity-100 transform translate-y-0 scale-100"
          x-transition:leave-end="opacity-0 transform -translate-y-2 scale-95"
        >
          <div class="toast-content" x-html="toast.content"></div>
        </div>
      </template>
    </div>

    <div class="container" x-data="diceRoller()" x-init="init()" x-cloak>
      <!-- Desktop multiplayer button (top-left) -->
      <div x-show="sessionFeaturesAvailable" class="desktop-multiplayer-button">
        <button @click="toggleSessionUI()" class="multiplayer-top-btn">
          <span x-show="sessionMode === 'solo'">üé≤ Play with Friends</span>
          <span x-show="sessionMode === 'multiplayer'">
            <span x-show="connectionStatus === 'connected'">üü¢</span>
            <span x-show="connectionStatus === 'connecting'">üü°</span>
            <span
              x-show="connectionStatus === 'disconnected' || connectionStatus === 'error'"
              >üî¥</span
            >
            <span
              x-text="connectedPlayers.length === 0 ? 'Waiting for others...' : 'Playing with Friends (' + (connectedPlayers.length + 1) + ')'"
            ></span>
          </span>
        </button>
      </div>

      <div
        class="header"
        :class="{ 'no-result': !result, 'has-result': result }"
      >
        <!-- Logo section - shows logo-text when no result -->
        <div class="logo-container" x-show="!result">
          <img
            alt="Dagger Dice"
            src="/src/assets/daggerdice-logo-text.png"
            class="logo-text"
          />
        </div>

        <!-- Result section with inline logo -->
        <div class="result-container" x-show="result">
          <img
            alt="Dagger Dice"
            src="/src/assets/daggerdice-logo.png"
            class="logo-only"
          />
          <h1 x-html="result"></h1>
        </div>
      </div>

      <div class="dice-container">
        <div id="dice-box"></div>
      </div>

      <!-- Desktop controls layout -->
      <div class="controls desktop-controls">
        <div class="modifiers">
          <div class="advantage-controls">
            <label>Roll Type:</label>
            <div class="toggle-buttons">
              <button
                @click="setAdvantageType('none')"
                :class="{ 'active': advantageType === 'none' }"
                class="toggle-btn"
                :disabled="isRolling"
              >
                Standard
              </button>
              <button
                @click="setAdvantageType('advantage')"
                :class="{ 'active': advantageType === 'advantage' }"
                class="toggle-btn"
                :disabled="isRolling"
              >
                Advantage
              </button>
              <button
                @click="setAdvantageType('disadvantage')"
                :class="{ 'active': advantageType === 'disadvantage' }"
                class="toggle-btn"
                :disabled="isRolling"
              >
                Disadvantage
              </button>
            </div>
          </div>

          <button
            @click="modifier = 0; advantageType = 'none'"
            class="modifier-clear-btn"
            x-show="(modifier !== 0 || advantageType != 'none') && !isRolling"
            title="Clear modifiers"
          >
            üîÑ Clear
          </button>

          <div class="modifier-controls">
            <label>Modifier:</label>
            <button
              @click="modifier = Math.max(modifier - 1, -20)"
              class="modifier-btn"
            >
              -
            </button>
            <span class="modifier-display" x-text="modifier"></span>
            <button
              @click="modifier = Math.min(modifier + 1, 20)"
              class="modifier-btn"
            >
              +
            </button>
          </div>
        </div>

        <button @click="rollDice()" :disabled="isRolling" class="roll-button">
          <span x-text="isRolling ? 'Rolling...' : 'Roll Dice'"></span>
        </button>
      </div>

      <!-- Mobile bottom bar -->
      <div class="mobile-bottom-bar" x-data="{ showModifiers: false, showActions: false, showHistoryDialog: false }">
        <!-- Bottom button bar -->
        <div class="bottom-button-bar">
          <!-- Left: Modifiers Button -->
          <div class="bottom-left">
            <button
              @click="showModifiers = !showModifiers; showActions = false"
              class="bottom-section-btn"
              :class="{ 'active': showModifiers }"
              title="Modifiers"
            >
              <div class="section-btn-content">
                <span class="section-btn-icon">‚öôÔ∏è</span>
                <span class="section-btn-text">Mods</span>
                <span class="section-btn-value" x-show="modifier !== 0 || advantageType !== 'none'" x-text="modifier"></span>
              </div>
            </button>
          </div>

          <!-- Center: Roll Button -->
          <div class="bottom-center">
            <div class="roll-button-container">
              <button @click="rollDice()" :disabled="isRolling" class="bottom-roll-button">
                <span x-text="isRolling ? 'Rolling...' : 'Roll'"></span>
              </button>
              <!-- Multiplayer indicator when connected -->
              <button
                x-show="sessionMode === 'multiplayer' && sessionFeaturesAvailable"
                @click="toggleSessionUI()"
                class="multiplayer-indicator"
                :class="connectionStatus"
                title="Multiplayer Session"
              >
                <span x-show="connectionStatus === 'connected'">üü¢</span>
                <span x-show="connectionStatus === 'connecting'">üü°</span>
                <span
                  x-show="connectionStatus === 'disconnected' || connectionStatus === 'error'"
                >üî¥</span>
                <span x-show="connectedPlayers.length > 0" class="player-count" x-text="connectedPlayers.length + 1"></span>
              </button>
            </div>
          </div>

          <!-- Right: Actions Button -->
          <div class="bottom-right">
            <button
              @click="showActions = !showActions; showModifiers = false"
              class="bottom-section-btn"
              :class="{ 'active': showActions }"
              title="History & Multiplayer"
            >
              <div class="section-btn-content">
                <span class="section-btn-icon">üìã</span>
                <span class="section-btn-text">More</span>
              </div>
            </button>
          </div>
        </div>

        <!-- Left Dialog: Modifiers -->
        <div
          class="mobile-dialog mobile-dialog-left"
          :class="{ 'visible': showModifiers }"
          x-show="showModifiers"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="transform translate-y-full"
          x-transition:enter-end="transform translate-y-0"
          x-transition:leave="transition ease-in duration-300"
          x-transition:leave-start="transform translate-y-0"
          x-transition:leave-end="transform translate-y-full"
        >
          <div class="dialog-header">
            <h3>Modifiers</h3>
            <button @click="showModifiers = false" class="dialog-close">‚úï</button>
          </div>
          
          <div class="dialog-content">
            <!-- Advantage/Disadvantage controls -->
            <div class="dialog-section">
              <label>Roll Type:</label>
              <div class="toggle-buttons">
                <button
                  @click="setAdvantageType('none')"
                  :class="{ 'active': advantageType === 'none' }"
                  class="toggle-btn"
                  :disabled="isRolling"
                >
                  Standard
                </button>
                <button
                  @click="setAdvantageType('advantage')"
                  :class="{ 'active': advantageType === 'advantage' }"
                  class="toggle-btn"
                  :disabled="isRolling"
                >
                  Advantage
                </button>
                <button
                  @click="setAdvantageType('disadvantage')"
                  :class="{ 'active': advantageType === 'disadvantage' }"
                  class="toggle-btn"
                  :disabled="isRolling"
                >
                  Disadvantage
                </button>
              </div>
            </div>

            <!-- Numeric modifier controls -->
            <div class="dialog-section">
              <label>Numeric Modifier:</label>
              <div class="modifier-controls-dialog">
                <button
                  @click="modifier = Math.max(modifier - 1, -20)"
                  class="modifier-btn-dialog"
                  title="Decrease modifier"
                >
                  -
                </button>
                <span class="modifier-display-dialog" x-text="modifier"></span>
                <button
                  @click="modifier = Math.min(modifier + 1, 20)"
                  class="modifier-btn-dialog"
                  title="Increase modifier"
                >
                  +
                </button>
              </div>
            </div>

            <!-- Clear button -->
            <div class="dialog-section">
              <button
                @click="modifier = 0; advantageType = 'none'; showModifiers = false"
                class="clear-all-btn"
                x-show="modifier !== 0 || advantageType !== 'none'"
                title="Clear all modifiers"
              >
                üîÑ Clear All Modifiers
              </button>
            </div>
          </div>
        </div>

        <!-- Right Dialog: Actions (History & Multiplayer) -->
        <div
          class="mobile-dialog mobile-dialog-right"
          :class="{ 'visible': showActions }"
          x-show="showActions"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="transform translate-y-full"
          x-transition:enter-end="transform translate-y-0"
          x-transition:leave="transition ease-in duration-300"
          x-transition:leave-start="transform translate-y-0"
          x-transition:leave-end="transform translate-y-full"
        >
          <div class="dialog-header">
            <h3>Actions</h3>
            <button @click="showActions = false" class="dialog-close">‚úï</button>
          </div>
          
          <div class="dialog-content">
            <!-- History section -->
            <div class="dialog-section">
              <button
                class="action-btn"
                @click="showHistoryDialog = true; showActions = false"
                title="Show Roll History"
              >
                <img src="/src/assets/history.svg" alt="History" class="action-btn-icon" />
                <span>Roll History</span>
              </button>
            </div>

            <!-- Multiplayer section -->
            <div class="dialog-section" x-show="sessionFeaturesAvailable">
              <button
                class="action-btn"
                @click="toggleSessionUI(); showActions = false"
                title="Multiplayer Options"
              >
                <span class="action-btn-icon">
                  <span x-show="sessionMode === 'solo'">üé≤</span>
                  <span x-show="sessionMode === 'multiplayer'">
                    <span x-show="connectionStatus === 'connected'">üü¢</span>
                    <span x-show="connectionStatus === 'connecting'">üü°</span>
                    <span
                      x-show="connectionStatus === 'disconnected' || connectionStatus === 'error'"
                      >üî¥</span
                    >
                  </span>
                </span>
                <span x-show="sessionMode === 'solo'">Play with Friends</span>
                <span x-show="sessionMode === 'multiplayer'">
                  <span
                    x-text="connectedPlayers.length === 0 ? 'Waiting for others...' : 'Playing with Friends (' + (connectedPlayers.length + 1) + ')'"
                  ></span>
                </span>
              </button>
            </div>
          </div>
        </div>

        <!-- Roll History Dialog -->
        <div
          class="mobile-dialog mobile-dialog-history"
          :class="{ 'visible': showHistoryDialog }"
          x-show="showHistoryDialog"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="transform translate-y-full"
          x-transition:enter-end="transform translate-y-0"
          x-transition:leave="transition ease-in duration-300"
          x-transition:leave-start="transform translate-y-0"
          x-transition:leave-end="transform translate-y-full"
        >
          <div class="dialog-header">
            <h3>Roll History</h3>
            <button @click="showHistoryDialog = false" class="dialog-close">‚úï</button>
          </div>
          
          <div class="dialog-content">
            <div x-show="rollHistory.length === 0" class="empty-history">
              No rolls yet. Roll some dice to see your history!
            </div>
            <div x-show="rollHistory.length > 0" class="history-list">
              <template
                x-for="(roll, index) in rollHistory.slice(0, 10)"
                :key="index"
              >
                <div class="history-item-dialog">
                  <!-- Player name on separate line for multiplayer -->
                  <div
                    x-show="sessionMode === 'multiplayer' && roll.playerName"
                    class="player-name-line"
                  >
                    <span x-text="roll.playerName"></span>
                  </div>

                  <div class="roll-details">
                    <div class="dice-values">
                      <span class="hope" x-text="roll.hopeValue"></span>
                      <span class="fear" x-text="roll.fearValue"></span>
                      <span
                        x-show="roll.advantageValue !== 0"
                        :class="roll.advantageValue > 0 ? 'advantage' : 'disadvantage'"
                        x-text="(roll.advantageValue > 0 ? '+' : '') + roll.advantageValue"
                      ></span>
                      <span
                        x-show="roll.modifier !== 0"
                        x-text="(roll.modifier > 0 ? '+' : '') + roll.modifier"
                      ></span>
                    </div>
                    <div class="outcome">
                      <template x-if="!roll.result.includes('Critical')">
                        <strong x-text="roll.total"></strong>
                      </template>
                      <small
                        x-text="roll.result.includes('hope') ? 'hope' : roll.result.includes('fear') ? 'fear' : 'crit'"
                      ></small>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- Backdrop to close dialogs -->
        <div
          class="dialog-backdrop"
          x-show="showModifiers || showActions || showHistoryDialog"
          @click="showModifiers = false; showActions = false; showHistoryDialog = false"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0"
          x-transition:enter-end="opacity-100"
          x-transition:leave="transition ease-in duration-300"
          x-transition:leave-start="opacity-100"
          x-transition:leave-end="opacity-0"
        ></div>
      </div>

      <!-- Desktop session panel backdrop -->
      <div
        class="desktop-session-backdrop"
        x-show="showSessionUI && sessionFeaturesAvailable"
        @click="toggleSessionUI()"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-300"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
      ></div>

      <!-- Desktop session panel -->
      <div
        x-show="showSessionUI && sessionFeaturesAvailable"
        class="session-panel desktop-session-panel"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform scale-95"
        x-transition:enter-end="opacity-100 transform scale-100"
        x-transition:leave="transition ease-in duration-300"
        x-transition:leave-start="opacity-100 transform scale-100"
        x-transition:leave-end="opacity-0 transform scale-95"
        @keydown.escape.window="showSessionUI && toggleSessionUI()"
      >
        <!-- Close button for desktop -->
        <button @click="toggleSessionUI()" class="desktop-dialog-close" title="Close">
          ‚úï
        </button>
        <!-- Solo mode: session creation/joining -->
        <div x-show="sessionMode === 'solo'" class="session-join">
          <h3>Multiplayer Room</h3>

          <div class="session-input">
            <input
              x-model="playerName"
              placeholder="Your name"
              required
              maxlength="20"
              class="player-name-input"
              @keyup.enter="joinSessionId.trim() ? joinSession() : createSession()"
            />
          </div>

          <div class="session-input">
            <input
              x-model="joinSessionId"
              placeholder="Room ID (optional)"
              class="session-id-input"
              type="search"
              maxlength="6"
              @input="handleRoomIdChange()"
              @keyup.enter="joinSessionId.trim() ? joinSession() : createSession()"
            />
          </div>

          <div class="session-action">
            <button
              @click="joinSessionId.trim() ? joinSession() : createSession()"
              :disabled="!playerName.trim() || connectionStatus === 'connecting' || !isJoinSessionValid"
              class="session-btn primary-btn"
            >
              <span x-show="connectionStatus === 'connecting'">
                <span
                  x-text="joinSessionId.trim() ? 'Joining...' : 'Creating...'"
                ></span>
              </span>
              <span x-show="connectionStatus !== 'connecting'">
                <span
                  x-text="joinSessionId.trim() ? 'Join Room' : 'Create New Room'"
                ></span>
              </span>
            </button>
          </div>

          <div x-show="connectionStatus === 'error'" class="session-error">
            Connection failed. Please try again.
          </div>
        </div>

        <!-- Multiplayer mode: room info -->
        <div x-show="sessionMode === 'multiplayer'" class="session-info">
          <div class="session-details">
            <div class="session-id-display">
              <strong>Room:</strong>
              <span x-text="sessionId" class="session-id"></span>
              <button
                @click="copySessionLink()"
                class="copy-btn"
                title="Copy room link"
              >
                üìã
              </button>
            </div>

            <div class="connection-status" :class="connectionStatus">
              <span x-show="connectionStatus === 'connected'"
                >üü¢ Connected</span
              >
              <span x-show="connectionStatus === 'connecting'"
                >üü° Connecting...</span
              >
              <span x-show="connectionStatus === 'disconnected'"
                >üî¥ Disconnected</span
              >
              <span x-show="connectionStatus === 'error'">‚ùå Error</span>
            </div>
          </div>

          <div class="players-list">
            <strong
              >Players (<span x-text="connectedPlayers.length + 1"></span
              >):</strong
            >
            <div class="players-container">
              <div class="player-item self">
                <span x-text="playerName + ' (you)'"></span>
              </div>
              <template x-for="player in connectedPlayers" :key="player.id">
                <div class="player-item">
                  <span x-text="player.name"></span>
                  <span x-show="!player.isActive" class="inactive">(away)</span>
                </div>
              </template>
            </div>
          </div>

          <button @click="leaveSession()" class="session-btn leave-btn">
            Leave Room
          </button>
        </div>
      </div>

      <!-- Mobile session panel -->
      <div
        x-show="showSessionUI && sessionFeaturesAvailable"
        class="session-panel mobile-session-panel"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="transform translate-y-full"
        x-transition:enter-end="transform translate-y-0"
        x-transition:leave="transition ease-in duration-300"
        x-transition:leave-start="transform translate-y-0"
        x-transition:leave-end="transform translate-y-full"
      >
        <!-- Session panel header -->
        <div class="dialog-header">
          <h3 x-show="sessionMode === 'solo'">Multiplayer Room</h3>
          <h3 x-show="sessionMode === 'multiplayer'">Room Info</h3>
          <button @click="toggleSessionUI()" class="dialog-close">‚úï</button>
        </div>

        <!-- Solo mode: session creation/joining -->
        <div x-show="sessionMode === 'solo'" class="session-join">
          <div class="dialog-content">
            <div class="session-input">
              <input
                x-model="playerName"
                placeholder="Your name"
                required
                maxlength="20"
                class="player-name-input"
                @keyup.enter="joinSessionId.trim() ? joinSession() : createSession()"
              />
            </div>

            <div class="session-input">
              <input
                x-model="joinSessionId"
                placeholder="Room ID (optional)"
                class="session-id-input"
                type="search"
                maxlength="6"
                @input="handleRoomIdChange()"
                @keyup.enter="joinSessionId.trim() ? joinSession() : createSession()"
              />
            </div>

            <div class="session-action">
              <button
                @click="joinSessionId.trim() ? joinSession() : createSession()"
                :disabled="!playerName.trim() || connectionStatus === 'connecting' || !isJoinSessionValid"
                class="session-btn primary-btn"
              >
                <span x-show="connectionStatus === 'connecting'">
                  <span
                    x-text="joinSessionId.trim() ? 'Joining...' : 'Creating...'"
                  ></span>
                </span>
                <span x-show="connectionStatus !== 'connecting'">
                  <span
                    x-text="joinSessionId.trim() ? 'Join Room' : 'Create New Room'"
                  ></span>
                </span>
              </button>
            </div>

            <div x-show="connectionStatus === 'error'" class="session-error">
              Connection failed. Please try again.
            </div>
          </div>
        </div>

        <!-- Multiplayer mode: room info -->
        <div x-show="sessionMode === 'multiplayer'" class="session-info">
          <div class="dialog-content">
            <div class="session-details">
              <div class="session-id-display">
                <strong>Room:</strong>
                <span x-text="sessionId" class="session-id"></span>
                <button
                  @click="copySessionLink()"
                  class="copy-btn"
                  title="Copy room link"
                >
                  üìã
                </button>
              </div>

              <div class="connection-status" :class="connectionStatus">
                <span x-show="connectionStatus === 'connected'"
                  >üü¢ Connected</span
                >
                <span x-show="connectionStatus === 'connecting'"
                  >üü° Connecting...</span
                >
                <span x-show="connectionStatus === 'disconnected'"
                  >üî¥ Disconnected</span
                >
                <span x-show="connectionStatus === 'error'">‚ùå Error</span>
              </div>
            </div>

            <div class="players-list">
              <strong
                >Players (<span x-text="connectedPlayers.length + 1"></span
                >):</strong
              >
              <div class="players-container">
                <div class="player-item self">
                  <span x-text="playerName + ' (you)'"></span>
                </div>
                <template x-for="player in connectedPlayers" :key="player.id">
                  <div class="player-item">
                    <span x-text="player.name"></span>
                    <span x-show="!player.isActive" class="inactive">(away)</span>
                  </div>
                </template>
              </div>
            </div>

            <button @click="leaveSession()" class="session-btn leave-btn">
              Leave Room
            </button>
          </div>
        </div>
      </div>

      <!-- Session panel backdrop for mobile -->
      <div
        class="dialog-backdrop mobile-session-backdrop"
        x-show="showSessionUI && sessionFeaturesAvailable"
        @click="toggleSessionUI()"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-300"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
      ></div>

      <button
        class="history-toggle"
        @click="toggleHistory()"
        x-show="rollHistory.length || true"
      >
        <img src="/src/assets/history.svg" alt="History" class="history-icon" />
      </button>

      <div
        class="roll-history-panel"
        :class="{ 'visible': showHistory }"
        x-show="rollHistory.length > 0"
      >
        <div class="roll-history">
          <h3>Roll History</h3>
          <template
            x-for="(roll, index) in rollHistory.slice(0, 10)"
            :key="index"
          >
            <div class="history-item">
              <!-- Player name on separate line for cleaner look -->
              <div
                x-show="sessionMode === 'multiplayer' && roll.playerName"
                class="player-name-line"
              >
                <span x-text="roll.playerName"></span>
              </div>

              <div class="roll-details">
                <div class="dice-values">
                  <span class="hope" x-text="roll.hopeValue"></span>
                  <span class="fear" x-text="roll.fearValue"></span>
                  <span
                    x-show="roll.advantageValue !== 0"
                    :class="roll.advantageValue > 0 ? 'advantage' : 'disadvantage'"
                    x-text="(roll.advantageValue > 0 ? '+' : '') + roll.advantageValue"
                  ></span>
                  <span
                    x-show="roll.modifier !== 0"
                    x-text="(roll.modifier > 0 ? '+' : '') + roll.modifier"
                  ></span>
                </div>
                <div class="outcome">
                  <template x-if="!roll.result.includes('Critical')">
                    <strong x-text="roll.total"></strong>
                  </template>
                  <small
                    x-text="roll.result.includes('hope') ? 'hope' : roll.result.includes('fear') ? 'fear' : 'crit'"
                  ></small>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- Import the built JavaScript module -->
    <script type="module" src="/src/dice-roller-main.ts"></script>
  </body>
</html>
